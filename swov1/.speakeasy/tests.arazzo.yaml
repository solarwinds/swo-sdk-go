# NOTE:
#   Before running tests or codegen locally, you must replace __QUERY_START_TIME__ and __QUERY_END_TIME__ in this file.
#   Run:
#       python3 replace_env_in_yaml.py swov1/.speakeasy/tests.arazzo.yaml

arazzo: 1.0.1
info:
  title: SWO End-to-End CRUD Contract Tests
  summary: Contract tests that run against the SWO Public API
  version: 0.0.1
sourceDescriptions:
  - name: public-api
    url: https://api.na-01.cloud.solarwinds.com/v1/openapi.json
    type: openapi
x-speakeasy-test-server:
  baseUrl: "x-env: PUBLIC_SWO_API_STAGE_URL"
x-speakeasy-test-security:
  value:
    ApiToken: "x-env: SWO_STAGE_API_TOKEN"
workflows:
  # /v1/changeevents - Create change event operation
  - workflowId: changeEvents
    steps:
      - stepId: create
        description: Create a new change event
        operationId: createChangeEvent
        requestBody:
          contentType: application/json
          payload: {"name": "swo-sdk-e2e-test-event", "title": "SWO SDK E2E Test Deployment", "source": "swo-sdk-go-test", "description": "End-to-end test deployment event created by SWO SDK", "tags": {"environment": "test", "service": "swo-sdk", "version": "1.0.0"}}
        successCriteria:
          - condition: $statusCode == 202
          - condition: $response.header.Content-Type == application/json
          - condition: $response.body#/id != null
        outputs:
          eventId: $response.body#/id
  # /v1/metrics - Composite metrics CRUD operations
  - workflowId: compositeMetricsCrudLifecycle
    steps:
      - stepId: create
        operationId: createCompositeMetric
        requestBody:
          contentType: application/json
          payload: {"name": "composite.swo.sdk.e2e.create.metric.test", "displayName": "SWO SDK E2E Create Metric Test", "description": "SWO SDK composite metric end to end create test", "formula": "rate(system.disk.io[1m])", "units": "bytes/s"}
        successCriteria:
          - condition: $statusCode == 201
          - condition: $response.header.Content-Type == application/json
          - condition: $response.body#/name == "composite.swo.sdk.e2e.create.metric.test"
          - condition: $response.body#/displayName == "SWO SDK E2E Create Metric Test"
          - condition: $response.body#/description == "SWO SDK composite metric end to end create test"
          - condition: $response.body#/formula == "rate(system.disk.io[1m])"
          - condition: $response.body#/units == "bytes/s"
        outputs:
          name: $response.body#/name
      - stepId: getByName
        description: Retrieve the created metric by name
        operationId: getMetricByName
        dependsOn: create
        parameters:
          - name: name
            in: path
            value: $steps.create.outputs.name
        successCriteria:
          - condition: $statusCode == 200
          - condition: $response.header.Content-Type == application/json
          - condition: $response.body#/name == "composite.swo.sdk.e2e.create.metric.test"
          - condition: $response.body#/displayName == "SWO SDK E2E Create Metric Test"
          - condition: $response.body#/description == "SWO SDK composite metric end to end create test"
          - condition: $response.body#/formula == "rate(system.disk.io[1m])"
          - condition: $response.body#/units == "bytes/s"
        outputs:
          retrievedMetric: $response.body
      - stepId: update
        description: Update the created composite metric
        operationId: updateCompositeMetric
        dependsOn: getMetricByName
        parameters:
          - name: name
            in: path
            value: $steps.create.outputs.name
        requestBody:
          contentType: application/json
          payload: {"displayName": "SWO SDK E2E Updated Metric Test", "description": "SWO SDK composite metric end to end updated test", "formula": "rate(system.cpu.usage[2m])", "units": "bytes/s"}
        successCriteria:
          - condition: $statusCode == 200
          - condition: $response.header.Content-Type == application/json
          - condition: $response.body#/name == "composite.swo.sdk.e2e.create.metric.test"
          - condition: $response.body#/displayName == "SWO SDK E2E Updated Metric Test"
          - condition: $response.body#/description == "SWO SDK composite metric end to end updated test"
          - condition: $response.body#/formula == "rate(system.cpu.usage[2m])"
          - condition: $response.body#/units == "bytes/s"
        outputs:
          updatedMetric: $response.body
      - stepId: getUpdatedMetric
        description: Retrieve the updated metric to verify changes
        operationId: getMetricByName
        dependsOn: update
        parameters:
          - name: name
            in: path
            value: $steps.create.outputs.name
        successCriteria:
          - condition: $statusCode == 200
          - condition: $response.header.Content-Type == application/json
          - condition: $response.body#/name == "composite.swo.sdk.e2e.create.metric.test"
          - condition: $response.body#/displayName == "SWO SDK E2E Updated Metric Test"
          - condition: $response.body#/description == "SWO SDK composite metric end to end updated test"
          - condition: $response.body#/formula == "rate(system.cpu.usage[2m])"
          - condition: $response.body#/units == "bytes/s"
        outputs:
          finalMetric: $response.body
      - stepId: delete
        description: Delete the composite metric
        operationId: deleteCompositeMetric
        dependsOn: getUpdatedMetric
        parameters:
          - name: name
            in: path
            value: $steps.create.outputs.name
        successCriteria:
          - condition: $statusCode == 204
  # /v1/logs - Search logs operation
  - workflowId: logsSearch
    steps:
      - stepId: search
        description: Search logs with basic parameters
        operationId: searchLogs
        parameters:
          - name: filter
            in: query
            value: "level:info"
          - name: direction
            in: query
            value: "backward"
          - name: pageSize
            in: query
            value: 10
          - name: startTime
            in: query
            value: __QUERY_START_TIME__
          - name: endTime
            in: query
            value: __QUERY_END_TIME__
        successCriteria:
          - condition: $statusCode == 200
          - condition: $response.header.Content-Type == application/json
          - condition: $response.body#/pageInfo != null
  # /v1/logs - List log archives operation
  - workflowId: logsArchives
    steps:
      - stepId: list
        description: List log archives with parameters
        operationId: listLogArchives
        parameters:
          - name: pageSize
            in: query
            value: 10
          - name: startTime
            in: query
            value: __QUERY_START_TIME__
          - name: endTime
            in: query
            value: __QUERY_END_TIME__
        successCriteria:
          - condition: $statusCode == 200
          - condition: $response.header.Content-Type == application/json
          - condition: $response.body#/pageInfo != null
          - condition: $response.body#/logArchives[?(@.archiveSize == 0)] == []
  # /v1/tokens - Create token operation
  - workflowId: tokens
    steps:
      - stepId: create
        operationId: createToken
        requestBody:
          contentType: application/json
          payload:
            name: "swo-sdk-e2e-test-token"
            tags:
              server: "swo-sdk-e2e-test-server"
              tag_without_value: "swo-sdk-e2e-test-tag"
            type: ingestion
        successCriteria:
          - condition: $statusCode == 201
          - condition: $response.header.Content-Type == application/json
          - condition: $response.body#/token != null