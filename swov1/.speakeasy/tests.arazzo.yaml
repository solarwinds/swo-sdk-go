arazzo: 1.0.1
info:
  title: SWO End-to-End CRUD Contract Tests
  summary: Contract tests that run against the SWO Public API
  version: 0.0.1
sourceDescriptions:
  - name: public-api
    url: https://api.na-01.cloud.solarwinds.com/v1/openapi.json
    type: openapi
x-speakeasy-test-server:
  baseUrl: "x-env: PUBLIC_SWO_API_STAGE_URL"
x-speakeasy-test-security:
  value:
    ApiToken: "x-env: SWO_STAGE_API_TOKEN"
workflows:
  # /v1/changeevents - Create change event operation
  - workflowId: changeEvents
    steps:
      - stepId: create
        description: Create a new change event
        operationId: createChangeEvent
        requestBody:
          contentType: application/json
          payload: {"name": "swo-sdk-e2e-test-event", "title": "SWO SDK E2E Test Deployment", "source": "swo-sdk-go-test", "description": "End-to-end test deployment event created by SWO SDK", "tags": {"environment": "test", "service": "swo-sdk", "version": "1.0.0"}}
        successCriteria:
          - condition: $statusCode == 202
          - condition: $response.header.Content-Type == application/json
          - condition: $response.body#/id != null
        outputs:
          eventId: $response.body#/id
  # /v1/metrics - Composite metrics CRUD operations
  - workflowId: compositeMetricsCrudLifecycle
    steps:
      - stepId: create
        operationId: createCompositeMetric
        requestBody:
          contentType: application/json
          payload: {"name": "composite.swo.sdk.e2e.create.metric.test", "displayName": "SWO SDK E2E Create Metric Test", "description": "SWO SDK composite metric end to end create test", "formula": "rate(system.disk.io[1m])", "units": "bytes/s"}
        successCriteria:
          - condition: $statusCode == 201
          - condition: $response.header.Content-Type == application/json
          - condition: $response.body#/name == "composite.swo.sdk.e2e.create.metric.test"
          - condition: $response.body#/displayName == "SWO SDK E2E Create Metric Test"
          - condition: $response.body#/description == "SWO SDK composite metric end to end create test"
          - condition: $response.body#/formula == "rate(system.disk.io[1m])"
          - condition: $response.body#/units == "bytes/s"
        outputs:
          name: $response.body#/name
      - stepId: getByName
        description: Retrieve the created metric by name
        operationId: getMetricByName
        dependsOn: create
        parameters:
          - name: name
            in: path
            value: $steps.create.outputs.name
        successCriteria:
          - condition: $statusCode == 200
          - condition: $response.header.Content-Type == application/json
          - condition: $response.body#/name == "composite.swo.sdk.e2e.create.metric.test"
          - condition: $response.body#/displayName == "SWO SDK E2E Create Metric Test"
          - condition: $response.body#/description == "SWO SDK composite metric end to end create test"
          - condition: $response.body#/formula == "rate(system.disk.io[1m])"
          - condition: $response.body#/units == "bytes/s"
        outputs:
          retrievedMetric: $response.body
      - stepId: update
        description: Update the created composite metric
        operationId: updateCompositeMetric
        dependsOn: getMetricByName
        parameters:
          - name: name
            in: path
            value: $steps.create.outputs.name
        requestBody:
          contentType: application/json
          payload: {"displayName": "SWO SDK E2E Updated Metric Test", "description": "SWO SDK composite metric end to end updated test", "formula": "rate(system.cpu.usage[2m])", "units": "bytes/s"}
        successCriteria:
          - condition: $statusCode == 200
          - condition: $response.header.Content-Type == application/json
          - condition: $response.body#/name == "composite.swo.sdk.e2e.create.metric.test"
          - condition: $response.body#/displayName == "SWO SDK E2E Updated Metric Test"
          - condition: $response.body#/description == "SWO SDK composite metric end to end updated test"
          - condition: $response.body#/formula == "rate(system.cpu.usage[2m])"
          - condition: $response.body#/units == "bytes/s"
        outputs:
          updatedMetric: $response.body
      - stepId: getUpdatedMetric
        description: Retrieve the updated metric to verify changes
        operationId: getMetricByName
        dependsOn: update
        parameters:
          - name: name
            in: path
            value: $steps.create.outputs.name
        successCriteria:
          - condition: $statusCode == 200
          - condition: $response.header.Content-Type == application/json
          - condition: $response.body#/name == "composite.swo.sdk.e2e.create.metric.test"
          - condition: $response.body#/displayName == "SWO SDK E2E Updated Metric Test"
          - condition: $response.body#/description == "SWO SDK composite metric end to end updated test"
          - condition: $response.body#/formula == "rate(system.cpu.usage[2m])"
          - condition: $response.body#/units == "bytes/s"
        outputs:
          finalMetric: $response.body
      - stepId: delete
        description: Delete the composite metric
        operationId: deleteCompositeMetric
        dependsOn: getUpdatedMetric
        parameters:
          - name: name
            in: path
            value: $steps.create.outputs.name
        successCriteria:
          - condition: $statusCode == 204
  # /v1/logs - Search logs operation
  - workflowId: logsSearch
    steps:
      - stepId: search
        description: Search logs with basic parameters
        operationId: searchLogs
        parameters:
          - name: filter
            in: query
            value: "level:info"
          - name: direction
            in: query
            value: "backward"
          - name: pageSize
            in: query
            value: 10
          - name: startTime
            in: query
            value: __QUERY_START_TIME__
          - name: endTime
            in: query
            value: __QUERY_END_TIME__
        successCriteria:
          - condition: $statusCode == 200
          - condition: $response.header.Content-Type == application/json
          - condition: $response.body#/pageInfo != null
  # /v1/logs - List log archives operation
  - workflowId: logsArchives
    steps:
      - stepId: list
        description: List log archives with parameters
        operationId: listLogArchives
        parameters:
          - name: pageSize
            in: query
            value: 10
          - name: startTime
            in: query
            value: __QUERY_START_TIME__
          - name: endTime
            in: query
            value: __QUERY_END_TIME__
        successCriteria:
          - condition: $statusCode == 200
          - condition: $response.header.Content-Type == application/json
          - condition: $response.body#/pageInfo != null
          - condition: $response.body#/logArchives != null
  # /v1/tokens - Create ingestion token operation
  - workflowId: tokens
    steps:
      - stepId: create
        description: Create ingestion token for contract tests (mirroring TestSDK_CreateTokens)
        operationId: createToken
        requestBody:
          contentType: application/json
          payload:
            {
              "name": "swo-sdk-e2e-test-token",
              "tags": {
                "server": "swo-sdk-e2e-test-server",
                "tag_without_value": "swo-sdk-e2e-test-tag"
              },
              "type": "ingestion"
            }
        successCriteria:
          - condition: $statusCode == 201
          - condition: $response.header.Content-Type == application/json
          - condition: $response.body#/token != null
        outputs:
          token: $response.body#/token
      - stepId: delete
        description: Delete the created ingestion token (using the signature from the created token)
        operationId: deleteToken
        dependsOn: create
        parameters:
          - name: tokenSig
            in: path
            value: ${steps.create.outputs.token.slice(-43)}
        successCriteria:
          - condition: $statusCode == 200
  # /v1/dbo - Database observability CRUD operations
  - workflowId: dboCrudLifecycle
    steps:
      - stepId: observeDatabase
        description: Add database observability to a database
        operationId: observeDatabase
        requestBody:
          contentType: application/json
          payload:
            {
              "name": "swo-sdk-e2e-db",
              "type": "postgresql",
              "connection": "postgres://user:pass@localhost:5432/dbname",
              "tags": { "environment": "test", "service": "swo-sdk-db" }
            }
        successCriteria:
          - condition: $statusCode == 201
          - condition: $response.header.Content-Type == application/json
          - condition: $response.body#/id != null
        outputs:
          entityId: $response.body#/id

      - stepId: updateDatabase
        description: Update observed database tags
        operationId: updateDatabase
        dependsOn: observeDatabase
        parameters:
          - name: entityId
            in: path
            value: $steps.observeDatabase.outputs.entityId
        requestBody:
          contentType: application/json
          payload:
            {
              "tags": { "environment": "updated-test", "service": "swo-sdk-db-updated" }
            }
        successCriteria:
          - condition: $statusCode == 204

      - stepId: getPluginConfig
        description: Get config of plugins observing a database
        operationId: getPluginConfig
        dependsOn: updateDatabase
        parameters:
          - name: entityId
            in: path
            value: $steps.observeDatabase.outputs.entityId
        successCriteria:
          - condition: $statusCode == 200
          - condition: $response.header.Content-Type == application/json

      - stepId: getPlugins
        description: Get status of plugins observing a database
        operationId: getPlugins
        dependsOn: updateDatabase
        parameters:
          - name: entityId
            in: path
            value: $steps.observeDatabase.outputs.entityId
        successCriteria:
          - condition: $statusCode == 200
          - condition: $response.header.Content-Type == application/json

      - stepId: deleteDatabase
        description: Delete the observed database
        operationId: deleteDatabase
        dependsOn: getPluginConfig
        parameters:
          - name: entityId
            in: path
            value: $steps.observeDatabase.outputs.entityId
        successCriteria:
          - condition: $statusCode == 204

  - workflowId: dboConfigLifecycle
    steps:
      - stepId: setConfig
        description: Set configuration for DBO agents/plugins
        operationId: setConfig
        requestBody:
          contentType: application/json
          payload:
            [
              { "key": "disable-sampling", "value": true }
            ]
        successCriteria:
          - condition: $statusCode == 204

      - stepId: getConfig
        description: Get configuration for DBO agents/plugins
        operationId: getConfig
        dependsOn: setConfig
        successCriteria:
          - condition: $statusCode == 200
          - condition: $response.header.Content-Type == application/json
          - condition: $response.body#/config != null

  - workflowId: dboPublicKey
    steps:
      - stepId: getPublicKey
        description: Get public key for encrypting database credentials locally
        operationId: getPublicKey
        successCriteria:
          - condition: $statusCode == 200
          - condition: $response.header.Content-Type == application/json
          - condition: $response.body#/publicKey != null

  - workflowId: dboPluginOperation
    steps:
      - stepId: pluginOperation
        description: Apply an operation on a database plugin (restart)
        operationId: pluginOperation
        parameters:
          - name: entityId
            in: path
            value: __DYNAMIC_ENTITY_ID__   # Replace with valid entityId
          - name: operation
            in: path
            value: "restart"
        requestBody:
          contentType: application/json
          payload: {}
        successCriteria:
          - condition: $statusCode == 204